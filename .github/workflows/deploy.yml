name: Deploy EchoRoom API to AWS App Runner

on:
  push:
    branches: [main]
    paths:
      - 'services/api/**'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1  # Change to your preferred region
  ECR_REPOSITORY: echoroom-api
  APP_RUNNER_SERVICE: echoroom-api

jobs:
  deploy:
    name: Deploy to App Runner
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
      
    - name: Build, tag, and push image to Amazon ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        cd services/api
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
    - name: Deploy to App Runner
      run: |
        aws apprunner start-deployment \
          --service-arn arn:aws:apprunner:${{ env.AWS_REGION }}:${{ secrets.AWS_ACCOUNT_ID }}:service/${{ env.APP_RUNNER_SERVICE }}/XXXXXXXXXXXXX
        
    # Optional: Wait for deployment to complete
    - name: Wait for deployment
      run: |
        echo "Waiting for App Runner deployment to complete..."
        aws apprunner describe-service \
          --service-arn arn:aws:apprunner:${{ env.AWS_REGION }}:${{ secrets.AWS_ACCOUNT_ID }}:service/${{ env.APP_RUNNER_SERVICE }}/XXXXXXXXXXXXX \
          --query 'Service.Status' \
          --output text
        
    # Optional: Run smoke tests
    - name: Run smoke tests
      env:
        API_URL: ${{ secrets.APP_RUNNER_URL }}  # Set this in GitHub secrets
      run: |
        # Health check
        curl -f $API_URL/health
        
        # Basic API test (requires test API key)
        curl -f -X POST $API_URL/chat \
          -H "Content-Type: application/json" \
          -d '{"persona":"Einstein","message":"Hello","sessionId":"test-gh-actions"}'

# Required GitHub Secrets:
# - AWS_ACCESS_KEY_ID: AWS access key with ECR and App Runner permissions
# - AWS_SECRET_ACCESS_KEY: AWS secret access key
# - AWS_ACCOUNT_ID: Your 12-digit AWS account ID
# - APP_RUNNER_URL: Your App Runner service URL (for smoke tests)
#
# Required Setup:
# 1. Create ECR repository: aws ecr create-repository --repository-name echoroom-api
# 2. Create App Runner service (manual first deployment)
# 3. Get the App Runner service ARN and update the deploy step above
# 4. Set GitHub repository secrets
# 5. Update AWS_REGION and service names as needed